/**
 * Налаштування для Jest тестів
 * Цей файл виконується перед запуском тестів
 */

// Мок для AsyncStorage
jest.mock('@react-native-async-storage/async-storage', () =>
  require('@react-native-async-storage/async-storage/jest/async-storage-mock')
);

// Мок для jwt-decode
jest.mock('jwt-decode', () => ({
  __esModule: true,
  default: jest.fn((token) => {
    try {
      const payload = JSON.parse(atob(token.split('.')[1]));
      return payload;
    } catch {
      throw new Error('Invalid token');
    }
  })
}));

// Мок для React Native
jest.mock('react-native', () => {
  return {
    Platform: {
      OS: 'ios',
      select: jest.fn((obj) => obj.ios || obj.default)
    },
    Alert: {
      alert: jest.fn()
    },
    Linking: {
      openURL: jest.fn(() => Promise.resolve())
    },
    Dimensions: {
      get: jest.fn(() => ({ width: 375, height: 667 }))
    },
    StyleSheet: {
      create: jest.fn((styles) => styles)
    }
  };
});

// Мок для axios
jest.mock('axios', () => ({
  create: jest.fn(() => ({
    get: jest.fn(() => Promise.resolve({ data: {} })),
    post: jest.fn(() => Promise.resolve({ data: {} })),
    put: jest.fn(() => Promise.resolve({ data: {} })),
    delete: jest.fn(() => Promise.resolve({ data: {} })),
    interceptors: {
      request: {
        use: jest.fn()
      },
      response: {
        use: jest.fn()
      }
    }
  })),
  get: jest.fn(() => Promise.resolve({ data: {} })),
  post: jest.fn(() => Promise.resolve({ data: {} })),
  put: jest.fn(() => Promise.resolve({ data: {} })),
  delete: jest.fn(() => Promise.resolve({ data: {} }))
}));

// Мок для React Navigation
jest.mock('@react-navigation/native', () => {
  return {
    useNavigation: () => ({
      navigate: jest.fn(),
      goBack: jest.fn(),
      reset: jest.fn(),
      setOptions: jest.fn()
    }),
    useRoute: () => ({
      params: {}
    }),
    useFocusEffect: jest.fn(),
    NavigationContainer: ({ children }) => children
  };
});

// Мок для Expo
jest.mock('expo-constants', () => ({
  default: {
    manifest: {
      extra: {
        apiUrl: 'http://localhost:3000'
      }
    }
  }
}));

// Мок для react-native-vector-icons
jest.mock('react-native-vector-icons/MaterialIcons', () => 'MaterialIcons');
jest.mock('react-native-vector-icons/MaterialCommunityIcons', () => 'MaterialCommunityIcons');
jest.mock('react-native-vector-icons/Ionicons', () => 'Ionicons');

// Глобальні моки
global.fetch = jest.fn();
global.console = {
  ...console,
  log: jest.fn(),
  error: jest.fn(),
  warn: jest.fn(),
  info: jest.fn(),
  debug: jest.fn()
};

// Мок для btoa/atob (base64)
global.btoa = (str) => Buffer.from(str, 'binary').toString('base64');
global.atob = (str) => Buffer.from(str, 'base64').toString('binary');

// Налаштування часових зон для тестів
process.env.TZ = 'UTC';

// Збільшуємо таймаут для тестів
jest.setTimeout(10000);

// Глобальна обробка помилок
process.on('unhandledRejection', (reason, promise) => {
  console.error('Unhandled Rejection at:', promise, 'reason:', reason);
});

// Експорт утиліт для тестів
const mockNavigate = jest.fn();
const mockGoBack = jest.fn();
const mockReset = jest.fn();

const createMockNavigation = () => ({
  navigate: mockNavigate,
  goBack: mockGoBack,
  reset: mockReset,
  setOptions: jest.fn(),
  addListener: jest.fn(),
  removeListener: jest.fn(),
  isFocused: jest.fn(() => true)
});

const createMockRoute = (params = {}) => ({
  params,
  key: 'test-route',
  name: 'TestScreen'
});

module.exports = {
  mockNavigate,
  mockGoBack,
  mockReset,
  createMockNavigation,
  createMockRoute
};