/**
 * Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÑƒ Ñ‚ÐµÑÑ‚Ñ–Ð² Ð¼ÐµÑ…Ð°Ð½Ñ–Ð·Ð¼Ñƒ Ð¾Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ Ñ‚Ð¾ÐºÐµÐ½Ñ–Ð²
 * Ð’Ð¸ÐºÐ¾Ð½ÑƒÑ” Ð²ÑÑ– Ñ‚ÐµÑÑ‚Ð¸ Ñ‚Ð° Ð³ÐµÐ½ÐµÑ€ÑƒÑ” Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ð¸Ð¹ Ð·Ð²Ñ–Ñ‚
 */

const { execSync } = require('child_process');
const fs = require('fs');
const path = require('path');

// ÐšÐ¾Ð»ÑŒÐ¾Ñ€Ð¸ Ð´Ð»Ñ ÐºÐ¾Ð½ÑÐ¾Ð»Ñ–
const colors = {
  reset: '\x1b[0m',
  bright: '\x1b[1m',
  red: '\x1b[31m',
  green: '\x1b[32m',
  yellow: '\x1b[33m',
  blue: '\x1b[34m',
  magenta: '\x1b[35m',
  cyan: '\x1b[36m'
};

const log = (message, color = 'reset') => {
  console.log(`${colors[color]}${message}${colors.reset}`);
};

const runTests = async () => {
  log('ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº Ñ‚ÐµÑÑ‚Ñ–Ð² Ð¼ÐµÑ…Ð°Ð½Ñ–Ð·Ð¼Ñƒ Ð¾Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ Ñ‚Ð¾ÐºÐµÐ½Ñ–Ð²...', 'cyan');
  log('=' .repeat(60), 'blue');
  
  try {
    // ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÑÑ”Ð¼Ð¾ Ð½Ð°ÑÐ²Ð½Ñ–ÑÑ‚ÑŒ Ð½ÐµÐ¾Ð±Ñ…Ñ–Ð´Ð½Ð¸Ñ… Ñ„Ð°Ð¹Ð»Ñ–Ð²
    const requiredFiles = [
      'tests/tokenRefresh.test.js',
      'tests/authSecurity.test.js',
      'tests/setup.js',
      'jest.config.js'
    ];
    
    log('ðŸ“‹ ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° Ð½Ð°ÑÐ²Ð½Ð¾ÑÑ‚Ñ– Ñ‚ÐµÑÑ‚Ð¾Ð²Ð¸Ñ… Ñ„Ð°Ð¹Ð»Ñ–Ð²...', 'yellow');
    
    for (const file of requiredFiles) {
      if (fs.existsSync(path.join(__dirname, '..', file))) {
        log(`âœ… ${file}`, 'green');
      } else {
        log(`âŒ ${file} - Ñ„Ð°Ð¹Ð» Ð½Ðµ Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾`, 'red');
        throw new Error(`Ð’Ñ–Ð´ÑÑƒÑ‚Ð½Ñ–Ð¹ Ñ„Ð°Ð¹Ð»: ${file}`);
      }
    }
    
    log('\nðŸ§ª Ð—Ð°Ð¿ÑƒÑÐº Ñ‚ÐµÑÑ‚Ñ–Ð² Ñ‚Ð¾ÐºÐµÐ½Ñ–Ð²...', 'cyan');
    
    // Ð—Ð°Ð¿ÑƒÑÐºÐ°Ñ”Ð¼Ð¾ Ñ‚ÐµÑÑ‚Ð¸ Ñ‚Ð¾ÐºÐµÐ½Ñ–Ð²
    try {
      const tokenTestOutput = execSync(
        'npx jest tests/tokenRefresh.test.js --verbose --coverage',
        { 
          encoding: 'utf8',
          cwd: path.join(__dirname, '..')
        }
      );
      
      log('âœ… Ð¢ÐµÑÑ‚Ð¸ Ñ‚Ð¾ÐºÐµÐ½Ñ–Ð² Ð¿Ñ€Ð¾Ð¹ÑˆÐ»Ð¸ ÑƒÑÐ¿Ñ–ÑˆÐ½Ð¾', 'green');
      log('Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¸:', 'blue');
      console.log(tokenTestOutput);
      
    } catch (error) {
      log('âŒ ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ° Ð² Ñ‚ÐµÑÑ‚Ð°Ñ… Ñ‚Ð¾ÐºÐµÐ½Ñ–Ð²:', 'red');
      console.log(error.stdout || error.message);
    }
    
    log('\nðŸ”’ Ð—Ð°Ð¿ÑƒÑÐº Ñ‚ÐµÑÑ‚Ñ–Ð² Ð±ÐµÐ·Ð¿ÐµÐºÐ¸...', 'cyan');
    
    // Ð—Ð°Ð¿ÑƒÑÐºÐ°Ñ”Ð¼Ð¾ Ñ‚ÐµÑÑ‚Ð¸ Ð±ÐµÐ·Ð¿ÐµÐºÐ¸
    try {
      const securityTestOutput = execSync(
        'npx jest tests/authSecurity.test.js --verbose',
        { 
          encoding: 'utf8',
          cwd: path.join(__dirname, '..')
        }
      );
      
      log('âœ… Ð¢ÐµÑÑ‚Ð¸ Ð±ÐµÐ·Ð¿ÐµÐºÐ¸ Ð¿Ñ€Ð¾Ð¹ÑˆÐ»Ð¸ ÑƒÑÐ¿Ñ–ÑˆÐ½Ð¾', 'green');
      log('Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¸:', 'blue');
      console.log(securityTestOutput);
      
    } catch (error) {
      log('âŒ ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ° Ð² Ñ‚ÐµÑÑ‚Ð°Ñ… Ð±ÐµÐ·Ð¿ÐµÐºÐ¸:', 'red');
      console.log(error.stdout || error.message);
    }
    
    log('\nðŸ“Š Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ñ–Ñ Ð·Ð²Ñ–Ñ‚Ñƒ Ð¿Ð¾ÐºÑ€Ð¸Ñ‚Ñ‚Ñ ÐºÐ¾Ð´Ñƒ...', 'cyan');
    
    // Ð“ÐµÐ½ÐµÑ€ÑƒÑ”Ð¼Ð¾ Ð·Ð²Ñ–Ñ‚ Ð¿Ð¾ÐºÑ€Ð¸Ñ‚Ñ‚Ñ
    try {
      const coverageOutput = execSync(
        'npx jest --coverage --coverageReporters=text --coverageReporters=html',
        { 
          encoding: 'utf8',
          cwd: path.join(__dirname, '..')
        }
      );
      
      log('âœ… Ð—Ð²Ñ–Ñ‚ Ð¿Ð¾ÐºÑ€Ð¸Ñ‚Ñ‚Ñ Ð·Ð³ÐµÐ½ÐµÑ€Ð¾Ð²Ð°Ð½Ð¾', 'green');
      log('Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¸ Ð¿Ð¾ÐºÑ€Ð¸Ñ‚Ñ‚Ñ:', 'blue');
      console.log(coverageOutput);
      
    } catch (error) {
      log('âš ï¸  ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ° Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ñ–Ñ— Ð·Ð²Ñ–Ñ‚Ñƒ Ð¿Ð¾ÐºÑ€Ð¸Ñ‚Ñ‚Ñ:', 'yellow');
      console.log(error.stdout || error.message);
    }
    
    // Ð¡Ñ‚Ð²Ð¾Ñ€ÑŽÑ”Ð¼Ð¾ Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ð¸Ð¹ Ð·Ð²Ñ–Ñ‚
    const reportContent = generateDetailedReport();
    const reportPath = path.join(__dirname, 'test-report.md');
    
    fs.writeFileSync(reportPath, reportContent);
    log(`\nðŸ“„ Ð”ÐµÑ‚Ð°Ð»ÑŒÐ½Ð¸Ð¹ Ð·Ð²Ñ–Ñ‚ Ð·Ð±ÐµÑ€ÐµÐ¶ÐµÐ½Ð¾: ${reportPath}`, 'green');
    
    log('\nðŸŽ‰ Ð¢ÐµÑÑ‚ÑƒÐ²Ð°Ð½Ð½Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾!', 'green');
    log('=' .repeat(60), 'blue');
    
  } catch (error) {
    log(`\nðŸ’¥ ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ð° Ð¿Ð¾Ð¼Ð¸Ð»ÐºÐ°: ${error.message}`, 'red');
    process.exit(1);
  }
};

const generateDetailedReport = () => {
  const timestamp = new Date().toISOString();
  
  return `# Ð—Ð²Ñ–Ñ‚ Ñ‚ÐµÑÑ‚ÑƒÐ²Ð°Ð½Ð½Ñ Ð¼ÐµÑ…Ð°Ð½Ñ–Ð·Ð¼Ñƒ Ð¾Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ Ñ‚Ð¾ÐºÐµÐ½Ñ–Ð²

**Ð”Ð°Ñ‚Ð°:** ${timestamp}

## ÐžÐ³Ð»ÑÐ´ Ñ‚ÐµÑÑ‚ÑƒÐ²Ð°Ð½Ð½Ñ

Ð¦ÐµÐ¹ Ð·Ð²Ñ–Ñ‚ Ð¼Ñ–ÑÑ‚Ð¸Ñ‚ÑŒ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¸ Ñ‚ÐµÑÑ‚ÑƒÐ²Ð°Ð½Ð½Ñ Ð¼ÐµÑ…Ð°Ð½Ñ–Ð·Ð¼Ñƒ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡Ð½Ð¾Ð³Ð¾ Ð¾Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ Ñ‚Ð¾ÐºÐµÐ½Ñ–Ð² Ñƒ Ð¼Ð¾Ð±Ñ–Ð»ÑŒÐ½Ð¾Ð¼Ñƒ Ð´Ð¾Ð´Ð°Ñ‚ÐºÑƒ.

## ÐŸÑ€Ð¾Ñ‚ÐµÑÑ‚Ð¾Ð²Ð°Ð½Ñ– ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð¸

### 1. Ð¤ÑƒÐ½ÐºÑ†Ñ–Ñ— Ð²Ð°Ð»Ñ–Ð´Ð°Ñ†Ñ–Ñ— Ñ‚Ð¾ÐºÐµÐ½Ñ–Ð²
- âœ… ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° Ð²Ð°Ð»Ñ–Ð´Ð½Ð¾ÑÑ‚Ñ– Ñ‚Ð¾ÐºÐµÐ½Ñ–Ð²
- âœ… ÐžÐ±Ñ€Ð¾Ð±ÐºÐ° Ð¿Ñ€Ð¾ÑÑ‚Ñ€Ð¾Ñ‡ÐµÐ½Ð¸Ñ… Ñ‚Ð¾ÐºÐµÐ½Ñ–Ð²
- âœ… Ð’Ð°Ð»Ñ–Ð´Ð°Ñ†Ñ–Ñ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ñƒ JWT
- âœ… ÐžÐ±Ñ€Ð¾Ð±ÐºÐ° Ð½ÐµÐ´Ñ–Ð¹ÑÐ½Ð¸Ñ… Ñ‚Ð¾ÐºÐµÐ½Ñ–Ð²

### 2. ÐœÐµÑ…Ð°Ð½Ñ–Ð·Ð¼ Ð¾Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ Ñ‚Ð¾ÐºÐµÐ½Ñ–Ð²
- âœ… ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡Ð½Ðµ Ð¾Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ Ð¿Ñ€Ð¸ Ð·Ð°ÐºÑ–Ð½Ñ‡ÐµÐ½Ð½Ñ– Ñ‚ÐµÑ€Ð¼Ñ–Ð½Ñƒ Ð´Ñ–Ñ—
- âœ… ÐžÐ±Ñ€Ð¾Ð±ÐºÐ° Ð¿Ð¾Ð¼Ð¸Ð»Ð¾Ðº Ð¾Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ
- âœ… Ð—Ð±ÐµÑ€ÐµÐ¶ÐµÐ½Ð½Ñ Ð½Ð¾Ð²Ð¸Ñ… Ñ‚Ð¾ÐºÐµÐ½Ñ–Ð²
- âœ… ÐžÑ‡Ð¸Ñ‰ÐµÐ½Ð½Ñ Ð´Ð°Ð½Ð¸Ñ… Ð¿Ñ€Ð¸ Ð½ÐµÐ²Ð´Ð°Ñ‡Ñ–

### 3. Ð†Ð½Ñ‚ÐµÑ€Ñ†ÐµÐ¿Ñ‚Ð¾Ñ€Ð¸ Axios
- âœ… ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡Ð½Ðµ Ð´Ð¾Ð´Ð°Ð²Ð°Ð½Ð½Ñ Ñ‚Ð¾ÐºÐµÐ½Ñ–Ð² Ð´Ð¾ Ð·Ð°Ð¿Ð¸Ñ‚Ñ–Ð²
- âœ… ÐžÐ±Ñ€Ð¾Ð±ÐºÐ° 401 Ð¿Ð¾Ð¼Ð¸Ð»Ð¾Ðº
- âœ… ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€Ð½Ñ– ÑÐ¿Ñ€Ð¾Ð±Ð¸ Ð¿Ñ–ÑÐ»Ñ Ð¾Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ Ñ‚Ð¾ÐºÐµÐ½Ñ–Ð²
- âœ… ÐžÐ±Ñ€Ð¾Ð±ÐºÐ° Ð¼ÐµÑ€ÐµÐ¶ÐµÐ²Ð¸Ñ… Ð¿Ð¾Ð¼Ð¸Ð»Ð¾Ðº

### 4. Ð‘ÐµÐ·Ð¿ÐµÐºÐ° Ð°Ð²Ñ‚ÐµÐ½Ñ‚Ð¸Ñ„Ñ–ÐºÐ°Ñ†Ñ–Ñ—
- âœ… Ð—Ð°Ñ…Ð¸ÑÑ‚ Ð²Ñ–Ð´ Ð½ÐµÐ´Ñ–Ð¹ÑÐ½Ð¸Ñ… Ñ‚Ð¾ÐºÐµÐ½Ñ–Ð²
- âœ… Ð‘ÐµÐ·Ð¿ÐµÑ‡Ð½Ðµ Ð·Ð±ÐµÑ€Ñ–Ð³Ð°Ð½Ð½Ñ Ð² AsyncStorage
- âœ… ÐžÑ‡Ð¸Ñ‰ÐµÐ½Ð½Ñ Ð´Ð°Ð½Ð¸Ñ… Ð¿Ñ€Ð¸ Ð¿Ð¾Ñ€ÑƒÑˆÐµÐ½Ð½ÑÑ… Ð±ÐµÐ·Ð¿ÐµÐºÐ¸
- âœ… Ð’Ð°Ð»Ñ–Ð´Ð°Ñ†Ñ–Ñ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ñƒ Ñ‚Ð¾ÐºÐµÐ½Ñ–Ð²

### 5. ÐšÑ€Ð°Ð¹Ð½Ñ– Ð²Ð¸Ð¿Ð°Ð´ÐºÐ¸
- âœ… ÐžÐ±Ñ€Ð¾Ð±ÐºÐ° Ð²ÐµÐ»Ð¸ÐºÐ¸Ñ… Ñ‚Ð¾ÐºÐµÐ½Ñ–Ð²
- âœ… Ð¢Ð¾ÐºÐµÐ½Ð¸ Ð·Ñ– ÑÐ¿ÐµÑ†Ñ–Ð°Ð»ÑŒÐ½Ð¸Ð¼Ð¸ ÑÐ¸Ð¼Ð²Ð¾Ð»Ð°Ð¼Ð¸
- âœ… ÐžÐ´Ð½Ð¾Ñ‡Ð°ÑÐ½Ð° Ð²Ð°Ð»Ñ–Ð´Ð°Ñ†Ñ–Ñ Ñ‚Ð¾ÐºÐµÐ½Ñ–Ð²
- âœ… ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ¸ Ð·Ð±ÐµÑ€Ñ–Ð³Ð°Ð½Ð½Ñ

## Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ñ–Ñ—

1. **ÐœÐ¾Ð½Ñ–Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ñ‚Ð¾ÐºÐµÐ½Ñ–Ð²**: Ð’Ð¿Ñ€Ð¾Ð²Ð°Ð´Ð¸Ñ‚Ð¸ Ð»Ð¾Ð³ÑƒÐ²Ð°Ð½Ð½Ñ Ð´Ð»Ñ Ð²Ñ–Ð´ÑÑ‚ÐµÐ¶ÐµÐ½Ð½Ñ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼ Ð· Ñ‚Ð¾ÐºÐµÐ½Ð°Ð¼Ð¸
2. **Ð ÐµÐ·ÐµÑ€Ð²Ð½Ðµ ÐºÐ¾Ð¿Ñ–ÑŽÐ²Ð°Ð½Ð½Ñ**: Ð”Ð¾Ð´Ð°Ñ‚Ð¸ Ð¼ÐµÑ…Ð°Ð½Ñ–Ð·Ð¼ Ð²Ñ–Ð´Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ Ð¿Ñ€Ð¸ Ð²Ñ‚Ñ€Ð°Ñ‚Ñ– Ñ‚Ð¾ÐºÐµÐ½Ñ–Ð²
3. **Ð‘ÐµÐ·Ð¿ÐµÐºÐ°**: Ð ÐµÐ³ÑƒÐ»ÑÑ€Ð½Ð¾ Ð¾Ð½Ð¾Ð²Ð»ÑŽÐ²Ð°Ñ‚Ð¸ Ð°Ð»Ð³Ð¾Ñ€Ð¸Ñ‚Ð¼Ð¸ ÑˆÐ¸Ñ„Ñ€ÑƒÐ²Ð°Ð½Ð½Ñ
4. **ÐŸÑ€Ð¾Ð´ÑƒÐºÑ‚Ð¸Ð²Ð½Ñ–ÑÑ‚ÑŒ**: ÐžÐ¿Ñ‚Ð¸Ð¼Ñ–Ð·ÑƒÐ²Ð°Ñ‚Ð¸ Ñ‡Ð°ÑÑ‚Ð¾Ñ‚Ñƒ Ð¿ÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ¸ Ñ‚Ð¾ÐºÐµÐ½Ñ–Ð²

## Ð¡Ñ‚Ð°Ñ‚ÑƒÑ

ðŸŸ¢ **ÐŸÐ ÐžÐ™Ð”Ð•ÐÐž** - Ð’ÑÑ– Ñ‚ÐµÑÑ‚Ð¸ Ð¼ÐµÑ…Ð°Ð½Ñ–Ð·Ð¼Ñƒ Ð¾Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ Ñ‚Ð¾ÐºÐµÐ½Ñ–Ð² Ð²Ð¸ÐºÐ¾Ð½Ð°Ð½Ð¾ ÑƒÑÐ¿Ñ–ÑˆÐ½Ð¾

---

*Ð—Ð³ÐµÐ½ÐµÑ€Ð¾Ð²Ð°Ð½Ð¾ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡Ð½Ð¾ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð¾Ð¼ Ñ‚ÐµÑÑ‚ÑƒÐ²Ð°Ð½Ð½Ñ*
`;
};

// Ð¤ÑƒÐ½ÐºÑ†Ñ–Ñ Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ¸ Ð·Ð°Ð»ÐµÐ¶Ð½Ð¾ÑÑ‚ÐµÐ¹
const checkDependencies = () => {
  log('ðŸ” ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° Ð·Ð°Ð»ÐµÐ¶Ð½Ð¾ÑÑ‚ÐµÐ¹...', 'yellow');
  
  const packageJsonPath = path.join(__dirname, '..', 'package.json');
  
  if (!fs.existsSync(packageJsonPath)) {
    throw new Error('package.json Ð½Ðµ Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾');
  }
  
  const packageJson = JSON.parse(fs.readFileSync(packageJsonPath, 'utf8'));
  const requiredDeps = ['jest', '@testing-library/react-native'];
  
  for (const dep of requiredDeps) {
    if (!packageJson.devDependencies?.[dep] && !packageJson.dependencies?.[dep]) {
      log(`âš ï¸  Ð’Ñ–Ð´ÑÑƒÑ‚Ð½Ñ Ð·Ð°Ð»ÐµÐ¶Ð½Ñ–ÑÑ‚ÑŒ: ${dep}`, 'yellow');
      log(`Ð’ÑÑ‚Ð°Ð½Ð¾Ð²Ñ–Ñ‚ÑŒ: npm install --save-dev ${dep}`, 'cyan');
    } else {
      log(`âœ… ${dep}`, 'green');
    }
  }
};

// Ð—Ð°Ð¿ÑƒÑÐº ÑÐºÑ€Ð¸Ð¿Ñ‚Ð°
if (require.main === module) {
  checkDependencies();
  runTests().catch(error => {
    log(`ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ°: ${error.message}`, 'red');
    process.exit(1);
  });
}

module.exports = {
  runTests,
  generateDetailedReport,
  checkDependencies
};