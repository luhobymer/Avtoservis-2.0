# План доопрацювання та синхронізації функціоналу (Web vs Mobile)

Цей документ сформовано на основі аудиту поточної кодової бази станом на 2026-02-11. Мета — забезпечити паритет функціональності між Web та Mobile додатками та "довести до розуму" кабінет клієнта.

## 1. Синхронізація Mobile App (React Native) з Web

### 1.1. Завершення запису (Appointment Completion)
**Проблема:** У Web майстер може завершити запис із введенням пробігу, додаванням запчастин (вручну або через OCR) та нотатками. У Mobile є лише зміна статусу на `completed`.
**Задачі:**
- [x] Створити екран/модалку `CompleteAppointmentScreen` у Mobile.
- [x] Додати поля: `completion_mileage`, `completion_notes`.
- [x] Додати секцію "Використані запчастини" (список + додавання).
- [x] Інтегрувати існуючий компонент `PartPhotoInput` (OCR) у флоу завершення запису.
- [x] Викликати API `PUT /api/appointments/:id/status` з розширеним пейлоадом.

### 1.2. Вибір майстра (Relationships)
**Проблема:** У Web клієнт при записі бачить "Моїх механіків" (фільтр по `relationships`). У Mobile список майстрів вантажиться просто по місту/всіх, ігноруючи персональні зв'язки.
**Задачі:**
- [x] Додати в `appointmentsService.js` метод `listMyMechanics()`.
- [x] Оновити `CreateAppointmentScreen`: додати таб/фільтр "Мої майстри" vs "Всі".
- [x] Відображати статус ("Запрошено", "Активний") біля майстра.

### 1.3. Експорт Сервісної Книжки
**Проблема:** Web має генерацію PDF. Mobile показує список, але не має кнопки "Завантажити/Поділитись PDF".
**Задачі:**
- [x] Додати кнопку "Share PDF" у `ServiceBookScreen`.
- [x] Підключити Mobile і Web до серверного PDF (`/api/reports/service-history/:vin`).
- [x] Перенести генерацію PDF на сервер (`/api/reports/service-history/:vin`), щоб обидва клієнти тягнули файл.

### 1.4. Нижнє меню (Bottom Navigation)
**Проблема:** У Mobile в нижньому меню можуть бути зайві або дубльовані пункти.
**Поточний стан (Mobile → MainNavigator):**
- Клієнтські вкладки: Dashboard, Vehicles, ServiceBook, Appointments, Profile.
- ServiceRecords та Notifications перенесені зі вкладок у Stack навігацію.
- Interactions прибрано з табів як дубль із Notifications.
**Поточний стан (Mobile → AdminNavigator):**
- Адмінські вкладки: AdminDashboard, Users, Services, Parts, AdminAppointments, Statistics.
**Задачі:**
- [x] Провести ревізію пунктів нижнього меню та прибрати зайві.
- [x] Узгодити структуру вкладок з ключовими сценаріями Mobile/Web.
- [x] Вирішити між ServiceBook та ServiceRecords, залишити один екран у табах.
- [x] Вирішити між Interactions та Notifications, залишити один екран у табах.
- [x] Звести клієнтське нижнє меню до 4–5 ключових вкладок.

## 2. Доопрацювання Web (Client Cabinet)

### 2.1. Мої Запчастини (My Parts) & OCR
**Проблема:** Сторінка існує, OCR працює (через API), але кнопка "Зберегти" — це `alert('Demo')`. Немає зв'язку з реальним збереженням.
**Задачі:**
- [x] Реалізувати бекенд-ендпоінт `POST /api/vehicle-parts` (якщо відсутній) або розширити `POST /api/appointments/:id/parts`.
- [x] У `MyParts.jsx`: додати вибір автомобіля (dropdown) при додаванні запчастини.
- [x] Зв'язати кнопку "Зберегти" з API.

### 2.2. Страхування (Insurance)
**Проблема:** Є UI `InsuranceManagement.jsx`, але сервер не має роутів для страхування. Це "мертва" фіча.
**Задачі:**
- [x] **Варіант А (швидкий):** Приховати розділ "Страхування" в меню, поки немає бекенду.
- [x] **Варіант Б (правильний):** Створити таблицю `insurances`, CRUD-контролер та роути на сервері.

### 2.3. Двофакторна аутентифікація (2FA)
**Проблема:** Є UI-заглушки.
**Задачі:**
- [x] Перевірити роботоздатність `/api/auth/2fa` (на сервері код є).
- [x] Підключити реальні виклики в `TwoFactorAuth.jsx`.

## 3. Загальні покращення (Shared)

### 3.1. Статуси записів
**Статус:** Виконано (Web приведено до `confirmed`/`in_progress`).
**Наступні кроки:**
- [x] Перевірити, чи Mobile коректно відображає кольори для `in_progress` (snake_case).

### 3.2. Нагадування (Reminders)
**Проблема:** Mobile має локальні нагадування + список. Web не має інтерфейсу для нагадувань.
**Задачі:**
- [x] Додати сторінку "Нагадування" у Web (список ТО, страховок).
- [x] Синхронізувати налаштування нагадувань через сервер.

### 3.3. Регламент ТО (Maintenance Schedule)
**Мета:** Розробити та реалізувати повноцінний графік обслуговування авто (регламент) з пунктами, нормами та нагадуваннями.
**Задачі:**
- [x] **Database:** Створити таблицю `maintenance_schedules` (vehicle_id, service_item, interval_km, interval_months, last_service_date, last_service_mileage).
- [x] **Backend:** Реалізувати CRUD API для регламенту (`/api/maintenance`).
- [x] **Logic:** Реалізувати логіку розрахунку "наступного ТО" на основі пробігу/часу.
- [x] **UI (Web/Mobile):** Екран "Регламент ТО" з можливістю редагування пунктів (наприклад, "Заміна масла" кожні 10 тис. км).
- [x] **Notifications:** Автоматичне створення нагадувань при наближенні терміну.

### 3.4. Локалізація (i18n)
**Мета:** Зберігати паритет ключів між локалями.
**Задачі:**
- [x] Перевірити локалі на повноту ключів.
- [x] Додати npm-скрипт `check:locales` у клієнті.
- [x] Додати npm-скрипт `check:placeholders` для валідації плейсхолдерів (наприклад, `{{seconds}}`) між мовами.
- [x] Інтегрувати перевірки локалей у CI (GitHub Actions/Cloudflare Pipeline): запуск `npm run check:locales` та `npm run check:placeholders` на кожен PR.
- [ ] Додати керівництво для розробників: як додавати нові ключі та плейсхолдери узгоджено у трьох мовах.

## 4. Інфраструктура та деплой (Cloudflare)

- [x] Додати R2-завантаження файлів у бекенд з fallback на локальний диск.
- [x] Додати захищений ендпоінт для запуску перевірки нагадувань.
- [x] Налаштувати Cloudflare Cron Trigger для виклику `/api/reminders/run-check`.
- [ ] Винести storage повністю у R2 з доменом або public URL.
- [ ] Перенести бекенд на Workers (Hono/itty-router) із D1/R2.
- [x] Підключити Google авторизацію (Web).
- [ ] Додати вхід за номером телефону (якщо потрібно) або чітко зафіксувати, що доступ лише через email/Google.

### 4.1. Чекліст перед деплоєм
**Backend**
- [ ] Перевірити `.env` у продакшні: `JWT_SECRET`, `CLOUDFLARE_*`, `SERVER_API_KEY`, `APP_BASE_URL`, `CORS_ORIGIN`.
- [ ] Переконатися, що D1 та R2 доступні з продакшн токеном.
- [ ] Запустити `npm run lint` у `server`.
- [ ] Перевірити `/health`, `/api/auth/login`, `/api/auth/google`, `/api/users/me`.

**Frontend**
- [ ] Перевірити `VITE_GOOGLE_CLIENT_ID` та продакшн origins у Google Console.
- [ ] Запустити `npm run lint` та `npm run typecheck` у `client`.
- [ ] Зібрати `npm run build` і перевірити старт.

## Пріоритет виконання (Roadmap)

1. **Тиждень 1: Mobile Parity (Завершення запису)** — критично для майстрів.
2. **Тиждень 1: Web Fixes (My Parts)** — щоб клієнти могли реально користуватися OCR.
3. **Тиждень 2: Relationships (Mobile)** — для зручності повторних записів.
4. **Тиждень 2: Insurance/Reminders** — розширення функціоналу.

## 5. Telegram Bot

**Поточний стан:** базові флоу логіну/реєстрації працюють, роль зберігається для подальшого розмежування.

**Задачі:**
- [x] Додати вибір ролі при реєстрації (клієнт/механік).
- [x] Зберігати роль у Telegram-профілі після авторизації.
- [x] Базово фільтрувати клієнтські дії для ролі механіка.
- [ ] Розширити окремі сценарії для механіка (список записів, робочі флоу).

**Примітка:** роль механіка в Telegram відповідає ролі `master` у бекенді.
